<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>xG Model Deep Analysis - Real Data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #f472b6; margin-bottom: 10px; font-size: 2.2rem; }
    h2 { color: #38bdf8; margin: 30px 0 15px; font-size: 1.4rem; border-bottom: 2px solid #334155; padding-bottom: 10px; }
    .subtitle { color: #94a3b8; margin-bottom: 30px; font-size: 1.1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .card {
      background: rgba(30, 41, 59, 0.8);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #334155;
      backdrop-filter: blur(10px);
    }
    .card-title { color: #f472b6; font-size: 1.1rem; margin-bottom: 15px; font-weight: 600; }
    .chart-container { position: relative; height: 320px; }
    .chart-container-lg { position: relative; height: 400px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #334155; }
    th { color: #94a3b8; font-weight: 600; background: rgba(51, 65, 85, 0.5); }
    .positive { color: #4ade80; font-weight: 600; }
    .negative { color: #f87171; font-weight: 600; }
    .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
    .stat-box {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #334155;
    }
    .stat-value { font-size: 2rem; font-weight: bold; }
    .stat-value.red { color: #f87171; }
    .stat-value.green { color: #4ade80; }
    .stat-value.blue { color: #38bdf8; }
    .stat-value.purple { color: #a78bfa; }
    .stat-label { font-size: 0.85rem; color: #94a3b8; margin-top: 8px; }
    .alert {
      background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%);
      border: 1px solid #dc2626;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .alert-title { color: #fca5a5; font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; }
    .alert-text { color: #fecaca; }
    .insight {
      background: linear-gradient(135deg, #1e3a5f 0%, #172554 100%);
      border-left: 4px solid #38bdf8;
      padding: 15px 20px;
      margin: 20px 0;
      border-radius: 0 12px 12px 0;
    }
    .finding {
      background: linear-gradient(135deg, #14532d 0%, #052e16 100%);
      border-left: 4px solid #4ade80;
      padding: 15px 20px;
      margin: 20px 0;
      border-radius: 0 12px 12px 0;
    }
    .warning {
      background: linear-gradient(135deg, #713f12 0%, #451a03 100%);
      border-left: 4px solid #fbbf24;
      padding: 15px 20px;
      margin: 20px 0;
      border-radius: 0 12px 12px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>xG Model Calibration Analysis</h1>
    <p class="subtitle">Real NHL Data: 2022-2025 Seasons (501,336 shots)</p>

    <!-- Alert Banner -->
    <div class="alert">
      <div class="alert-title">‚ö†Ô∏è MAJOR CALIBRATION ISSUES DETECTED</div>
      <div class="alert-text">
        The xG model <strong>overestimates goals by 22.5%</strong>.
        Primary issues: <strong>Empty Net</strong> (predicts 82%, actual 14%) and
        <strong>Penalty Kill</strong> (predicts 21%, actual 8%).
      </div>
    </div>

    <!-- Summary Stats -->
    <div class="stat-grid">
      <div class="stat-box">
        <div class="stat-value blue">501,336</div>
        <div class="stat-label">Total Shots</div>
      </div>
      <div class="stat-box">
        <div class="stat-value green">25,785</div>
        <div class="stat-label">Actual Goals (5.14%)</div>
      </div>
      <div class="stat-box">
        <div class="stat-value purple">31,578</div>
        <div class="stat-label">Predicted xG (6.30%)</div>
      </div>
      <div class="stat-box">
        <div class="stat-value red">-22.5%</div>
        <div class="stat-label">Calibration Error</div>
      </div>
    </div>

    <!-- Key Findings -->
    <h2>Key Findings</h2>
    <div class="grid-3">
      <div class="alert" style="margin: 0;">
        <div class="alert-title">üö® Empty Net Detection</div>
        <div class="alert-text">
          Model predicts <strong>82.2%</strong> conversion<br>
          Actual: <strong>13.6%</strong><br>
          Error: <strong>-68.7%</strong>
        </div>
      </div>
      <div class="alert" style="margin: 0;">
        <div class="alert-title">üö® Penalty Kill</div>
        <div class="alert-text">
          Model predicts <strong>20.6%</strong> conversion<br>
          Actual: <strong>8.4%</strong><br>
          Error: <strong>-12.2%</strong>
        </div>
      </div>
      <div class="finding" style="margin: 0;">
        <div style="color: #86efac; font-weight: 700; font-size: 1.2rem; margin-bottom: 10px;">‚úì Even Strength</div>
        <div style="color: #bbf7d0;">
          Model predicts <strong>4.5%</strong> conversion<br>
          Actual: <strong>4.4%</strong><br>
          Error: <strong>-0.1%</strong> (Good!)
        </div>
      </div>
    </div>

    <!-- Shot Type Analysis -->
    <h2>Shot Type Analysis (NOT in current model)</h2>
    <div class="warning">
      <strong>Shot type is a significant predictor not included in the model.</strong>
      Snap shots convert at 8.8% but model predicts 5.4% ‚Äî a 3.5% underestimate.
    </div>
    <div class="grid">
      <div class="card">
        <div class="card-title">Actual vs Predicted by Shot Type</div>
        <div class="chart-container">
          <canvas id="shotTypeChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Shot Type Calibration Error</div>
        <div class="chart-container">
          <canvas id="shotTypeError"></canvas>
        </div>
      </div>
    </div>

    <!-- Strength State -->
    <h2>Strength State Analysis</h2>
    <div class="grid">
      <div class="card">
        <div class="card-title">Actual vs Predicted by Strength</div>
        <div class="chart-container">
          <canvas id="strengthChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Volume by Strength State</div>
        <div class="chart-container">
          <canvas id="strengthVolume"></canvas>
        </div>
      </div>
    </div>

    <!-- Distance Analysis -->
    <h2>Distance Analysis</h2>
    <div class="grid">
      <div class="card">
        <div class="card-title">Actual vs Predicted by Distance</div>
        <div class="chart-container">
          <canvas id="distanceChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Shots by Distance</div>
        <div class="chart-container">
          <canvas id="distanceVolume"></canvas>
        </div>
      </div>
    </div>

    <!-- Empty Net / Rebound -->
    <h2>Situation Analysis</h2>
    <div class="grid">
      <div class="card">
        <div class="card-title">Empty Net vs Goalie In</div>
        <div class="chart-container">
          <canvas id="emptyNetChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Rebound vs Non-Rebound</div>
        <div class="chart-container">
          <canvas id="reboundChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Calibration Buckets -->
    <h2>Calibration by xG Probability Bucket</h2>
    <div class="card">
      <div class="card-title">Where the Model Fails</div>
      <div class="chart-container-lg">
        <canvas id="bucketChart"></canvas>
      </div>
    </div>
    <div class="insight">
      <strong>High xG buckets (35-50%) are massively wrong</strong> because they contain empty net shots.
      The model assigns ~80% xG to empty nets but actual conversion is only ~14%.
    </div>

    <!-- Detailed Table -->
    <h2>Feature Calibration Summary</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Feature</th>
            <th>Shots</th>
            <th>Goals</th>
            <th>Actual %</th>
            <th>xG %</th>
            <th>Error</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Even Strength</strong></td>
            <td>406,829</td>
            <td>17,872</td>
            <td>4.4%</td>
            <td>4.5%</td>
            <td class="positive">-0.1%</td>
            <td class="positive">‚úì Good</td>
          </tr>
          <tr>
            <td><strong>Power Play</strong></td>
            <td>45,549</td>
            <td>3,803</td>
            <td>8.3%</td>
            <td>7.2%</td>
            <td class="positive">+1.1%</td>
            <td class="positive">‚úì Good</td>
          </tr>
          <tr>
            <td><strong>Penalty Kill</strong></td>
            <td>48,958</td>
            <td>4,110</td>
            <td>8.4%</td>
            <td>20.6%</td>
            <td class="negative">-12.2%</td>
            <td class="negative">‚úó Bad</td>
          </tr>
          <tr>
            <td><strong>Goalie In Net</strong></td>
            <td>493,677</td>
            <td>24,746</td>
            <td>5.0%</td>
            <td>5.1%</td>
            <td class="positive">-0.1%</td>
            <td class="positive">‚úì Good</td>
          </tr>
          <tr>
            <td><strong>Empty Net</strong></td>
            <td>7,659</td>
            <td>1,039</td>
            <td>13.6%</td>
            <td>82.2%</td>
            <td class="negative">-68.7%</td>
            <td class="negative">‚úó Very Bad</td>
          </tr>
          <tr>
            <td><strong>Non-Rebound</strong></td>
            <td>452,682</td>
            <td>21,532</td>
            <td>4.8%</td>
            <td>5.8%</td>
            <td class="negative">-1.1%</td>
            <td style="color: #fbbf24;">~ OK</td>
          </tr>
          <tr>
            <td><strong>Rebound</strong></td>
            <td>48,654</td>
            <td>4,253</td>
            <td>8.7%</td>
            <td>10.9%</td>
            <td class="negative">-2.1%</td>
            <td style="color: #fbbf24;">~ OK</td>
          </tr>
          <tr>
            <td><strong>0-10ft Distance</strong></td>
            <td>60,790</td>
            <td>6,750</td>
            <td>11.1%</td>
            <td>11.1%</td>
            <td class="positive">0.0%</td>
            <td class="positive">‚úì Perfect</td>
          </tr>
          <tr>
            <td><strong>Snap Shot</strong></td>
            <td>61,313</td>
            <td>5,420</td>
            <td>8.8%</td>
            <td>5.4%</td>
            <td class="positive">+3.5%</td>
            <td style="color: #fbbf24;">Underestimates</td>
          </tr>
          <tr>
            <td><strong>Wrist Shot</strong></td>
            <td>188,956</td>
            <td>12,176</td>
            <td>6.4%</td>
            <td>5.5%</td>
            <td class="positive">+0.9%</td>
            <td style="color: #fbbf24;">Underestimates</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- xG Distribution -->
    <h2>xG Probability Distribution</h2>
    <div class="grid">
      <div class="card">
        <div class="card-title">Distribution of xG Values</div>
        <div class="chart-container">
          <canvas id="distChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Statistics</div>
        <table>
          <tr><th>Metric</th><th>Value</th></tr>
          <tr><td>Mean xG</td><td>6.30%</td></tr>
          <tr><td>Median xG</td><td>4.44%</td></tr>
          <tr><td>Std Dev</td><td>10.06%</td></tr>
          <tr><td>10th Percentile</td><td>1.83%</td></tr>
          <tr><td>25th Percentile</td><td>2.73%</td></tr>
          <tr><td>75th Percentile</td><td>6.87%</td></tr>
          <tr><td>90th Percentile</td><td>9.66%</td></tr>
          <tr><td>95th Percentile</td><td>12.49%</td></tr>
          <tr><td>99th Percentile</td><td>80.08%</td></tr>
        </table>
      </div>
    </div>

    <!-- Recommendations -->
    <h2>Recommendations</h2>
    <div class="card">
      <table>
        <thead><tr><th>Priority</th><th>Issue</th><th>Fix</th></tr></thead>
        <tbody>
          <tr>
            <td><strong>1. Critical</strong></td>
            <td>Empty net detection is broken</td>
            <td>Check situationCode parsing - likely detecting too many empty nets</td>
          </tr>
          <tr>
            <td><strong>2. Critical</strong></td>
            <td>Penalty kill massively overestimates</td>
            <td>Verify strength state logic - may be mislabeling situations</td>
          </tr>
          <tr>
            <td><strong>3. High</strong></td>
            <td>Shot type not in model</td>
            <td>Add shotType feature - snap shots are 3.5% more dangerous than predicted</td>
          </tr>
          <tr>
            <td><strong>4. Medium</strong></td>
            <td>Distance overestimates beyond 10ft</td>
            <td>Retrain distance coefficient or add non-linear term</td>
          </tr>
          <tr>
            <td><strong>5. Quick Fix</strong></td>
            <td>Overall calibration</td>
            <td>Scale all xG by 0.816 (25785/31578) as interim fix</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    // Shot Type Chart
    const shotTypes = ['wrist', 'snap', 'slap', 'tip-in', 'backhand', 'deflected', 'wrap', 'poke', 'bat'];
    const shotActual = [6.4, 8.8, 4.9, 8.3, 8.2, 9.3, 5.7, 13.2, 13.6];
    const shotXG = [5.5, 5.4, 4.5, 8.9, 8.0, 9.5, 7.0, 11.7, 10.4];

    new Chart(document.getElementById('shotTypeChart'), {
      type: 'bar',
      data: {
        labels: shotTypes,
        datasets: [
          { label: 'Actual %', data: shotActual, backgroundColor: '#4ade80' },
          { label: 'xG %', data: shotXG, backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Shot Type Error
    const shotError = shotActual.map((a, i) => (a - shotXG[i]).toFixed(1));
    const shotErrorColors = shotError.map(e => e >= 0 ? '#4ade80' : '#f87171');
    new Chart(document.getElementById('shotTypeError'), {
      type: 'bar',
      data: {
        labels: shotTypes,
        datasets: [{ label: 'Error', data: shotError, backgroundColor: shotErrorColors }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Strength Chart
    new Chart(document.getElementById('strengthChart'), {
      type: 'bar',
      data: {
        labels: ['Even Strength', 'Power Play', 'Penalty Kill'],
        datasets: [
          { label: 'Actual %', data: [4.4, 8.3, 8.4], backgroundColor: '#4ade80' },
          { label: 'xG %', data: [4.5, 7.2, 20.6], backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Strength Volume
    new Chart(document.getElementById('strengthVolume'), {
      type: 'doughnut',
      data: {
        labels: ['Even Strength (406,829)', 'Penalty Kill (48,958)', 'Power Play (45,549)'],
        datasets: [{ data: [406829, 48958, 45549], backgroundColor: ['#3b82f6', '#f87171', '#4ade80'] }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } }
      }
    });

    // Distance Chart
    new Chart(document.getElementById('distanceChart'), {
      type: 'bar',
      data: {
        labels: ['0-10ft', '10-20ft', '20-30ft', '30-40ft', '40-50ft', '50+ft'],
        datasets: [
          { label: 'Actual %', data: [11.1, 6.7, 5.7, 4.0, 2.4, 1.9], backgroundColor: '#4ade80' },
          { label: 'xG %', data: [11.1, 8.8, 6.5, 5.0, 4.1, 2.9], backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Distance Volume
    new Chart(document.getElementById('distanceVolume'), {
      type: 'bar',
      data: {
        labels: ['0-10ft', '10-20ft', '20-30ft', '30-40ft', '40-50ft', '50+ft'],
        datasets: [{ label: 'Shots', data: [60790, 104466, 92066, 88459, 66038, 89513], backgroundColor: '#38bdf8' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
        }
      }
    });

    // Empty Net Chart
    new Chart(document.getElementById('emptyNetChart'), {
      type: 'bar',
      data: {
        labels: ['Goalie In Net', 'Empty Net'],
        datasets: [
          { label: 'Actual %', data: [5.0, 13.6], backgroundColor: '#4ade80' },
          { label: 'xG %', data: [5.1, 82.2], backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Rebound Chart
    new Chart(document.getElementById('reboundChart'), {
      type: 'bar',
      data: {
        labels: ['Non-Rebound', 'Rebound'],
        datasets: [
          { label: 'Actual %', data: [4.8, 8.7], backgroundColor: '#4ade80' },
          { label: 'xG %', data: [5.8, 10.9], backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' } }
        }
      }
    });

    // Calibration Buckets
    new Chart(document.getElementById('bucketChart'), {
      type: 'bar',
      data: {
        labels: ['0-5%', '5-10%', '10-15%', '15-20%', '20-25%', '25-30%', '30-35%', '35-40%', '40-45%', '45-50%'],
        datasets: [
          { label: 'Actual %', data: [4.4, 11.7, 14.6, 25.0, 32.1, 31.6, 26.0, 15.1, 10.1, 12.8], backgroundColor: '#4ade80' },
          { label: 'Predicted %', data: [4.5, 12.7, 21.9, 33.5, 45.1, 53.4, 63.5, 73.4, 82.1, 90.6], backgroundColor: '#a78bfa' }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#94a3b8' } } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', callback: v => v + '%' }, max: 100 }
        }
      }
    });

    // Distribution
    new Chart(document.getElementById('distChart'), {
      type: 'bar',
      data: {
        labels: ['0-2%', '2-4%', '4-6%', '6-8%', '8-10%', '10-15%', '15-20%', '20-50%', '50%+'],
        datasets: [{ label: 'Shots', data: [89000, 180000, 120000, 50000, 25000, 15000, 5000, 8000, 9000], backgroundColor: '#38bdf8' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
          y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
        }
      }
    });
  </script>
</body>
</html>
